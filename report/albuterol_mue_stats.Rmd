---
title: "Albuterol MUE Statistics"
author: "Megan Moore, Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(knitr.table.format = "html")
```

```{r}
library(tidyverse)
library(broom)
library(rlang)
library(kableExtra)
library(themebg)

x <- dirr::get_rds("../data/tidy/megan")
id_col <- "millennium.id"

cont_cols <- c(
    "Variable", 
    "Median", 
    "25th", 
    "75th",
    "Median", 
    "25th", 
    "75th",
    "p-value", 
    "low", 
    "high"
)

cat_cols <- c("Variable", "n", "%", "n", "%", "p-value")

make_header <- function(df, len = 3, ci = TRUE) {
    cnt <- count(df, year)

    x <- paste("n =", cnt$n[[1]])
    y <- paste("n =", cnt$n[[2]])
    z <- "95% CI"
    
    hdr <- c(" " = 1, x = len, y = len, " " = 1)
    nm <- c(" ", x, y, " ")
    
    if (ci) {
        hdr <- c(hdr, z = 2)
        names(hdr) <- c(nm, z)
    } else {
        names(hdr) <- nm
    }    
    
    hdr
}

hdr_year <- function(len = 3, ci = TRUE) {
    x <- c(" ", "2016" = len, "2017" = len, " ")
    if (ci) x <- c(x, " ", " ")
    
    x
}

p_cont <- function(df, ...) {
    grp <- quos(...)
    var_name <- sym("var_name")
    
    df %>%
        gather("var_name", "value", !!!grp) %>%
        group_by(!!var_name) %>%
        do(
            tidy(
                wilcox.test(
                    value ~ year, 
                    data = ., 
                    conf.int = TRUE
                )
            )
        ) %>%
        select(
            !!var_name, 
            !!sym("p.value"), 
            !!sym("conf.low"),
            !!sym("conf.high")
        ) %>%
        ungroup()
}

p_cat <- function(df, ...) {
    grp <- quos(...)
    var_name <- sym("var_name")

    df %>%
        select(!!sym("year"), !!!grp) %>%
        gather("var_name", "value", !!!grp) %>%
        group_by(!!var_name) %>%
        do(
            tidy(
                chisq.test(
                    .$year, .$value
                )
            )
        ) %>%
        select(
            !!var_name, 
            !!sym("p.value")
        )
}


```

```{r, eval=FALSE}
data_demographics %>%
    select(age, age.days, length.stay, height, weight) %>%
    gather(key, value) %>%
    ggplot(aes(sample = value)) +
    geom_qq() +
    facet_wrap(~ key, scales = "free") +
    theme_bg()
```


```{r}
p_demog <- data_demographics %>%
    p_cont(age, age.days, length.stay, height, weight)

data_demographics %>%
    group_by(year) %>%
    summarize_at(
        c("age", "age.days", "length.stay", "height", "weight"), 
        funs(median, q25 = quantile(., 0.25), q75 = quantile(., 0.75)), 
        na.rm = TRUE
    ) %>%
    gather(var_name, result, -year) %>%
    separate(var_name, c("var_name", "measure"), sep = "_") %>%
    spread(measure, result) %>%
    unite(all_measures, median, q25, q75) %>%
    spread(year, all_measures) %>%
    separate(`2016`, c("median_1", "q25_1", "q75_1"), sep = "_") %>%
    separate(`2017`, c("median_2", "q25_2", "q75_2"), sep = "_") %>%
    left_join(p_demog, by = "var_name") %>%
    mutate_at(
        c("median_1", "q25_1", "q75_1", "median_2", "q25_2", "q75_2"), 
        as.numeric
    ) %>%
    mutate_at(
        "var_name", 
        str_replace_all, 
        pattern = c(
            "age.days" = "Age (days)",
            "age" = "Age (years)", 
            "length.stay" = "Length of stay",
            "height" = "Height (cm)",
            "weight" = "Weight (kg)"
        )
    ) %>%
    knitr::kable(
        digits = c(rep(1, 7), rep(3, 3)), 
        caption = "Baseline characteristics",
        booktabs = TRUE,
        col.names = cont_cols
    ) %>%
    kable_styling() %>%
    add_header_above(make_header(data_demographics)) %>%
    add_header_above(hdr_year())
```

```{r}

p_gender <- data_demographics %>%
    p_cat(gender, race)

df_gender <- data_demographics %>%
    filter(!is.na(gender),
           gender == "Male") %>%
    count(year, gender) %>%
    rename(var_name = gender, 
           result = n) %>%
    left_join(
        count(data_demographics, year), 
        by = "year"
    ) %>%
    mutate(pct = result / n * 100) %>%
    select(-n) %>%
    unite(result_pct, result, pct) %>%
    spread(year, result_pct) %>%
    separate(`2016`, c("result1", "pct1"), sep = "_") %>%
    separate(`2017`, c("result2", "pct2"), sep = "_") %>%
    mutate_at(
        c("result1", "pct1", "result2", "pct2"), 
        as.numeric
    ) %>%
    mutate(var = "gender")

df_race <- data_demographics %>%
    mutate_at("race", funs(coalesce(., "Unknown"))) %>%
    filter(!is.na(race)) %>%
    count(year, race) %>%
    rename(
        var_name = race, 
        result = n
    ) %>%
    left_join(
        count(data_demographics, year), 
        by = "year"
    ) %>%
    mutate(pct = result / n * 100) %>%
    select(-n) %>%
    unite(result_pct, result, pct) %>%
    spread(year, result_pct) %>%
    separate(`2016`, c("result1", "pct1"), sep = "_") %>%
    separate(`2017`, c("result2", "pct2"), sep = "_") %>%
    mutate_at(
        c("result1", "pct1", "result2", "pct2"), 
        as.numeric
    ) %>%
    mutate_at(
        c("result1", "pct1", "result2", "pct2"), 
        funs(coalesce(., 0))
    ) %>%
    arrange(desc(pct1)) %>%
    mutate(var = "race_val")

df_gender %>%
    add_row(var_name = "Race", var = "race") %>%
    bind_rows(df_race) %>%
    left_join(p_gender, by = c("var" = "var_name")) %>%
    select(-var) %>%
    knitr::kable(
        digits = c(rep(0, 5), 3),
        booktabs = TRUE,
        caption = "Baseline demographics",
        col.names = cat_cols
    ) %>%
    kable_styling() %>%
    add_header_above(
        header = make_header(data_demographics, 2, ci = FALSE)
    ) %>%
    add_header_above(hdr_year(2, FALSE)) %>%
    group_rows("", 3, nrow(df_race) + 2, label_row_css = "")

```

```{r, eval=FALSE}
data_cont_albuterol_summary %>%
    ggplot(aes(sample = time.wt.avg)) +
    geom_qq() +
    theme_bg()
```

```{r}
p_cont_alb <- data_cont_albuterol_summary %>%
    p_cont(cum.dose, first.rate, max.rate, duration, time.wt.avg)

data_cont_albuterol_summary %>%
    group_by(year) %>%
    summarize_at(
        c("cum.dose", "first.rate", "max.rate", "duration", "time.wt.avg"), 
        funs(median, q25 = quantile(., 0.25), q75 = quantile(., 0.75)), 
        na.rm = TRUE
    ) %>%
    gather(var_name, result, -year) %>%
    separate(var_name, c("var_name", "measure"), sep = "_") %>%
    spread(measure, result) %>%
    unite(all_measures, median, q25, q75) %>%
    spread(year, all_measures) %>%
    separate(`2016`, c("median_1", "q25_1", "q75_1"), sep = "_") %>%
    separate(`2017`, c("median_2", "q25_2", "q75_2"), sep = "_") %>%
    left_join(p_cont_alb, by = "var_name") %>%
    mutate_at(
        c("median_1", "q25_1", "q75_1", "median_2", "q25_2", "q75_2"), 
        as.numeric
    ) %>%
    mutate_at(
        "var_name", 
        str_replace_all, 
        pattern = c(
            "cum.dose" = "Cumulative dose (mg)",
            "first.rate" = "Initial rate (mg/hr)", 
            "max.rate" = "Maximum rate (mg/hr)",
            "duration" = "Duration of infusion until intermittent (hr)",
            "time.wt.avg" = "Time-weighted average infusion rate (mg/hr)"
        )
    ) %>%
    knitr::kable(
        digits = c(rep(1, 7), rep(3, 3)), 
        caption = "Continuous albuterol data (not weight-based)",
        booktabs = TRUE,
        col.names = cont_cols
    ) %>%
    kable_styling() %>%
    add_header_above(header = make_header(data_cont_albuterol_summary)) %>%
    add_header_above(hdr_year())
```

```{r}
p_cont_alb_wt <- data_cont_albuterol_summary_weight %>%
    p_cont(cum.dose, first.rate, max.rate, duration, time.wt.avg)

data_cont_albuterol_summary_weight %>%
    group_by(year) %>%
    summarize_at(
        c("cum.dose", "first.rate", "max.rate", "duration", "time.wt.avg"), 
        funs(median, q25 = quantile(., 0.25), q75 = quantile(., 0.75)), 
        na.rm = TRUE
    ) %>%
    gather(var_name, result, -year) %>%
    separate(var_name, c("var_name", "measure"), sep = "_") %>%
    spread(measure, result) %>%
    unite(all_measures, median, q25, q75) %>%
    spread(year, all_measures) %>%
    separate(`2016`, c("median_1", "q25_1", "q75_1"), sep = "_") %>%
    separate(`2017`, c("median_2", "q25_2", "q75_2"), sep = "_") %>%
    left_join(p_cont_alb_wt, by = "var_name") %>%
    mutate_at(
        c("median_1", "q25_1", "q75_1", "median_2", "q25_2", "q75_2"), 
        as.numeric
    ) %>%
    mutate_at(
        "var_name", 
        str_replace_all, 
        pattern = c(
            "cum.dose" = "Cumulative dose (mg/kg)",
            "first.rate" = "Initial rate (mg/kg/hr)", 
            "max.rate" = "Maximum rate (mg/kg/hr)",
            "duration" = "Duration of infusion until intermittent (hr)",
            "time.wt.avg" = "Time-weighted average infusion rate (mg/kg/hr)"
        )
    ) %>%
    knitr::kable(
        digits = c(rep(1, 7), rep(3, 3)), 
        caption = "Continuous albuterol data (weight-based)",
        booktabs = TRUE,
        col.names = cont_cols
    ) %>%
    kable_styling() %>%
    add_header_above(
        header = make_header(data_cont_albuterol_summary_weight)
    ) %>%
    add_header_above(hdr_year())
```

```{r}
df_overlap <- data_med_cont_10q2 %>%
    left_join(
        data_demographics[c(id_col, "year")], 
        by = id_col
    ) %>%
    mutate_at("overlap", as.numeric) 

p_cont_overlap <- df_overlap %>%
    p_cont(overlap)
    
df_overlap %>%
    group_by(year) %>%
    summarize_at(
        "overlap", 
        funs(median, q25 = quantile(., 0.25), q75 = quantile(., 0.75)), 
        na.rm = TRUE
    ) %>%
    mutate(var_name = "overlap") %>%
    unite(all_measures, median, q25, q75) %>%
    spread(year, all_measures) %>%
    separate(`2016`, c("median_1", "q25_1", "q75_1"), sep = "_") %>%
    separate(`2017`, c("median_2", "q25_2", "q75_2"), sep = "_") %>%
    left_join(p_cont_overlap, by = "var_name") %>%
    mutate_at(
        c("median_1", "q25_1", "q75_1", "median_2", "q25_2", "q75_2"), 
        as.numeric
    ) %>%
    mutate_at(
        "var_name", 
        str_replace_all, 
        pattern = c(
            "overlap" = "Duration of overlap (hr)"
        )
    ) %>%
    knitr::kable(
        digits = c(rep(1, 7), rep(3, 3)), 
        caption = "Combined continous albuterol 10 mg/hr and 10 puffs every 2 hr",
        booktabs = TRUE,
        col.names = cont_cols
    ) %>%
    kable_styling() %>%
    add_header_above(header = make_header(df_overlap)) %>%
    add_header_above(hdr_year())
```

```{r}
df_mag <- data_meds_mag_dosing %>%
    distinct(millennium.id) %>%
    mutate(mag = TRUE) %>%
    full_join(
        data_demographics[c(id_col, "year")], 
        by = id_col
    ) %>%
    mutate_at("mag", funs(coalesce(., FALSE))) 

p_mag <- df_mag %>%
    rename(Magnesium = mag) %>%
    p_cat(Magnesium)

df_mag %>%
    count(year, mag) %>%
    filter(mag == TRUE) %>%
    rename(result = n) %>%
    left_join(
        count(data_demographics, year), 
        by = "year"
    ) %>%
    mutate(pct = result / n * 100) %>%
    select(-n, -mag) %>%
    unite(result_pct, result, pct) %>%
    spread(year, result_pct) %>%
    separate(`2016`, c("result1", "pct1"), sep = "_") %>%
    separate(`2017`, c("result2", "pct2"), sep = "_") %>%
    mutate_at(
        c("result1", "pct1", "result2", "pct2"), 
        as.numeric
    ) %>%
    mutate(var = "Magnesium") %>%
    select(var, everything()) %>%
    left_join(p_mag, by = c("var" = "var_name")) %>%
    knitr::kable(
        digits = c(rep(0, 5), 3),
        booktabs = TRUE,
        caption = "Magnesium administration",
        col.names = cat_cols
    ) %>%
    kable_styling() %>%
    add_header_above(
        header = make_header(df_mag, 2, ci = FALSE)
    ) %>%
    add_header_above(hdr_year(2, ci = FALSE))

```

```{r}
df_mag_dose <- data_meds_mag_dosing %>%
    left_join(
        data_demographics[c(id_col, "year")],
        by = id_col
    ) %>%
    rename(num.doses = n)

p_mag_dose <- df_mag_dose %>%
    p_cont(num.doses)

df_mag_dose %>%
    group_by(year) %>%
    summarize_at(
        "num.doses", 
        funs(median, q25 = quantile(., 0.25), q75 = quantile(., 0.75)), 
        na.rm = TRUE
    ) %>%
    mutate(var_name = "num.doses") %>%
    unite(all_measures, median, q25, q75) %>%
    spread(year, all_measures) %>%
    separate(`2016`, c("median_1", "q25_1", "q75_1"), sep = "_") %>%
    separate(`2017`, c("median_2", "q25_2", "q75_2"), sep = "_") %>%
    left_join(p_mag_dose, by = "var_name") %>%
    mutate_at(
        c("median_1", "q25_1", "q75_1", "median_2", "q25_2", "q75_2"), 
        as.numeric
    ) %>%
    mutate_at(
        "var_name", 
        str_replace_all, 
        pattern = c(
            "num.doses" = "Number of doses"
        )
    ) %>%
    knitr::kable(
        digits = c(rep(1, 7), rep(3, 3)), 
        caption = "Baseline characteristics",
        booktabs = TRUE,
        col.names = cont_cols
    ) %>%
    kable_styling() %>%
    add_header_above(make_header(df_mag_dose)) %>%
    add_header_above(hdr_year())
```

