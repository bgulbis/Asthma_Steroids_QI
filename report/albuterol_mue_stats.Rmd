---
title: "Albuterol MUE Statistics"
author: "Megan Moore, Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(
    knitr.table.format = "html",
    knitr.kable.NA = ""
)
```

```{r}
library(tidyverse)
library(broom)
library(rlang)
library(kableExtra)
library(themebg)

x <- dirr::get_rds("../data/tidy/megan")
id_col <- "millennium.id"

cont_cols <- c(
    "Variable", 
    "Median", 
    "25th", 
    "75th",
    "Median", 
    "25th", 
    "75th",
    "p-value", 
    "low", 
    "high"
)

cat_cols <- c("Variable", "n", "%", "n", "%", "p-value")

make_header <- function(df, len = 3, ci = TRUE) {
    cnt <- count(df, year)

    x <- paste("n =", cnt$n[[1]])
    y <- paste("n =", cnt$n[[2]])
    z <- "95% CI"
    
    hdr <- c(" " = 1, x = len, y = len, " " = 1)
    nm <- c(" ", x, y, " ")
    
    if (ci) {
        hdr <- c(hdr, z = 2)
        names(hdr) <- c(nm, z)
    } else {
        names(hdr) <- nm
    }    
    
    hdr
}

hdr_year <- function(len = 3, ci = TRUE) {
    x <- c(" ", "2016" = len, "2017" = len, " ")
    if (ci) x <- c(x, " ", " ")
    
    x
}

p_cont <- function(df, ...) {
    grp <- quos(...)
    var_name <- sym("var_name")
    
    df %>%
        gather("var_name", "value", !!!grp) %>%
        group_by(!!var_name) %>%
        do(
            tidy(
                wilcox.test(
                    value ~ year, 
                    data = ., 
                    conf.int = TRUE
                )
            )
        ) %>%
        select(
            !!var_name, 
            !!sym("p.value"), 
            !!sym("conf.low"),
            !!sym("conf.high")
        ) %>%
        ungroup()
}

p_cat <- function(df, ...) {
    grp <- quos(...)
    var_name <- sym("var_name")

    df %>%
        select(!!sym("year"), !!!grp) %>%
        gather("var_name", "value", !!!grp) %>%
        group_by(!!var_name) %>%
        do(
            tidy(
                chisq.test(
                    .$year, .$value
                )
            )
        ) %>%
        select(
            !!var_name, 
            !!sym("p.value")
        )
}

# might break if only one continuous variable due to var_name becoming NA
df_cont <- function(df, p, ...) {
    grp <- quos(...)
    
    var_name <- sym("var_name")
    measure <- sym("measure")
    result <- sym("result")
    year <- sym("year")
    all_measures <- sym("all_measures")

    df %>%
        group_by(!!year) %>%
        summarize_at(
            vars(!!!grp), 
            funs(
                median, 
                q25 = quantile(., 0.25), 
                q75 = quantile(., 0.75)
            ), 
            na.rm = TRUE
        ) %>%
        gather(!!var_name, !!result, -!!year) %>%
        separate(
            !!var_name, 
            c("var_name", "measure"), 
            # c(!!var_name, !!measure), 
            sep = "_",
            fill = "left"
        ) %>%
        spread(!!measure, !!result) %>%
        unite(
            !!all_measures, 
            !!sym("median"), 
            !!sym("q25"), 
            !!sym("q75")
        ) %>%
        spread(!!year, !!all_measures) %>%
        separate(
            `2016`, 
            c("median_1", "q25_1", "q75_1"),
            sep = "_"
        ) %>%
        separate(
            `2017`, 
            c("median_2", "q25_2", "q75_2"), 
            sep = "_"
        ) %>%
        left_join(p, by = "var_name") %>%
        mutate_at(
            c(
                "median_1", 
                "q25_1", 
                "q75_1", 
                "median_2",
                "q25_2", 
                "q75_2"
            ), 
            as.numeric
        )
    
}

df_cat_logical <- function(df, p, ...) {
    grp <- quos(...)

    year <- sym("year")
    n_col <- sym("n")
    var_name <- sym("var_name")
    result <- sym("result")
    result_pct <- sym("result_pct")

    df %>%
        ungroup() %>%
        select(!!year, !!!grp) %>%
        add_count(!!year) %>%
        group_by(!!year, !!n_col) %>%
        summarize_if(is.logical, sum, na.rm = TRUE) %>%
        gather(!!var_name, !!result, -!!year, -!!n_col) %>%
        mutate(!!"pct" := !!result / !!n_col * 100) %>%
        select(-!!n_col) %>%
        unite(!!result_pct, !!result, !!sym("pct")) %>%
        spread(!!year, !!result_pct) %>%
        separate(`2016`, c("result1", "pct1"), sep = "_") %>%
        separate(`2017`, c("result2", "pct2"), sep = "_") %>%
        mutate_at(
            c("result1", "pct1", "result2", "pct2"), 
            as.numeric
        ) %>%
        left_join(p, by = "var_name")
}

df_cat_char <- function(df, ...) {
    x <- quos(...)

    year <- sym("year")
    n_col <- sym("n")
    var_name <- sym("var_name")
    result <- sym("result")
    result_pct <- sym("result_pct")

    df %>%
        ungroup() %>%
        select(!!sym("millennium.id"), !!year, !!!x) %>%
        add_count(!!year) %>%
        mutate(!!"val" := TRUE) %>%
        spread(!!x[[1]], !!sym("val")) %>%
        group_by(!!year, !!n_col) %>%
        summarize_if(is.logical, sum, na.rm = TRUE) %>%
        gather(!!var_name, !!result, -!!year, -!!n_col) %>%
        mutate(!!"pct" := !!result / !!n_col * 100) %>%
        select(-!!n_col) %>%
        unite(!!result_pct, !!result, !!sym("pct")) %>%
        spread(!!year, !!result_pct) %>%
        separate(`2016`, c("result1", "pct1"), sep = "_") %>%
        separate(`2017`, c("result2", "pct2"), sep = "_") %>%
        mutate_at(
            c("result1", "pct1", "result2", "pct2"), 
            as.numeric
        ) %>%
        arrange(desc(!!sym("pct1")))
}

make_cont_table <- function(df, var_name, caption, ...) {
    vars <- quos(...)
    
    p_df <- df %>%
        p_cont(...)
    
    df %>%
        df_cont(p = p_df, ...) %>%
        mutate_at(
            "var_name", 
            str_replace_all, 
            pattern = var_name
        ) %>%
        knitr::kable(
            digits = c(rep(1, 7), rep(3, 3)), 
            caption = caption,
            booktabs = TRUE,
            col.names = cont_cols
        ) %>%
        kable_styling() %>%
        add_header_above(make_header(df)) %>%
        add_header_above(hdr_year())    
}

make_cat_table <- function(df, var_name, caption, ...) {
    vars <- quos(...)
    
    p_df <- p_cat(df, ...)
    
    df %>%
        df_cat_logical(p = p_df, ...) %>%
        mutate_at(
            "var_name", 
            str_replace_all, 
            pattern = var_name
        ) %>%
        knitr::kable(
            digits = c(rep(0, 5), 3),
            booktabs = TRUE,
            caption = caption,
            col.names = cat_cols
        ) %>%
        kable_styling() %>%
        add_header_above(
            header = make_header(df, 2, ci = FALSE)
        ) %>%
        add_header_above(hdr_year(2, FALSE))
}

make_cat_char_table <- function(df, var_name, caption, ...) {
    p_df <- p_cat(df, ...)
    
    tbl <- df_cat_char(df, ...)

    p_df %>%
        bind_rows(tbl) %>%
        select(-!!sym("p.value"), everything()) %>%
        ungroup() %>%
        mutate_at(
            "var_name",
            str_replace_all,
            pattern = var_name
        ) %>%
        knitr::kable(
            digits = c(rep(0, 5), 3),
            booktabs = TRUE,
            caption = caption,
            col.names = cat_cols
        ) %>%
        kable_styling() %>%
        add_header_above(
            header = make_header(df_cat_all, 2, ci = FALSE)
        ) %>%
        add_header_above(hdr_year(2, FALSE)) %>%
        group_rows("", 2, nrow(tbl) + 1, label_row_css = "")
    
}

```

```{r, eval=FALSE}
data_demographics %>%
    select(age, age.days, length.stay, height, weight) %>%
    gather(key, value) %>%
    ggplot(aes(sample = value)) +
    geom_qq() +
    facet_wrap(~ key, scales = "free") +
    theme_bg()

```


```{r}
vars <- c(
    "age.days" = "Age (days)",
    "age" = "Age (years)", 
    "length.stay" = "Length of stay",
    "height" = "Height (cm)",
    "weight" = "Weight (kg)"
)

cap <- "Baseline characteristics"

data_demographics %>%
    make_cont_table(
        var_name = vars,
        caption = cap,
        age, age.days, length.stay, height, weight
    )
```

```{r}
cap <- "Baseline characteristics (continuous-only patients)"

data_demographics %>%
    filter(continuous) %>%
    make_cont_table(
        var_name = vars,
        caption = cap,
        age, age.days, length.stay, height, weight
    )
```

```{r}
df_cont_alb <- data_cont_albuterol_summary %>%
    distinct(millennium.id) %>%
    mutate(continuous = TRUE)

df_mag <- data_meds_mag_dosing %>%
    distinct(millennium.id) %>%
    mutate(magnesium = TRUE)

df_allergy <- data_meds_allergy_first %>%
    mutate(allergy.med = !is.na(med)) %>%
    select(-allergy.first.days)

df_cat_all <- data_demographics %>%
    select(-continuous) %>%
    left_join(df_cont_alb, by = "millennium.id") %>%
    left_join(df_mag, by = "millennium.id") %>%
    left_join(df_allergy, by = "millennium.id") %>%
    mutate_at(
        c("continuous", "magnesium", "allergy.med"), 
        funs(coalesce(., FALSE))) %>%
    mutate_at("race", funs(coalesce(., "Unknown"))
    ) %>%
    mutate(male = gender == "Male")

vars <- c(
    "magnesium" = "Magnesium given",
    "continuous" = "Continuous albuterol used",
    "male" = "Male",
    "allergy.med" = "Allergy medication given"
)

cap <- "Categorical data"

df_cat_all %>%
    make_cat_table(
        var_name = vars,
        caption = cap,
        male, continuous, magnesium, allergy.med
    )
```

```{r}
vars <- c("race" = "Race")

cap <- "Race"

df_cat_all %>%
    make_cat_char_table(
        var_name = vars,
        caption = cap,
        race
    )

```

```{r, eval=FALSE}
data_cont_albuterol_summary %>%
    ggplot(aes(sample = time.wt.avg)) +
    geom_qq() +
    theme_bg()
```

```{r}
vars <- c(
    "cum.dose" = "Cumulative dose (mg)",
    "first.rate" = "Initial rate (mg/hr)", 
    "max.rate" = "Maximum rate (mg/hr)",
    "duration" = "Duration of infusion until intermittent (hr)",
    "time.wt.avg" = "Time-weighted average infusion rate (mg/hr)"
)

cap <- "Continuous albuterol data (not weight-based)"

data_cont_albuterol_summary %>%
    make_cont_table(
        var_name = vars,
        caption = cap,
        cum.dose, first.rate, max.rate, duration, time.wt.avg
    )
```

```{r}
vars <- c(
    "cum.dose" = "Cumulative dose (mg)",
    "first.rate" = "Initial rate (mg/hr)", 
    "max.rate" = "Maximum rate (mg/hr)",
    "duration" = "Duration of infusion until intermittent (hr)",
    "time.wt.avg" = "Time-weighted average infusion rate (mg/hr)"
)

cap <- "Continuous albuterol data (weight-based)"

data_cont_albuterol_summary_weight %>%
    make_cont_table(
        var_name = vars,
        caption = cap,
        cum.dose, first.rate, max.rate, duration, time.wt.avg
    )
```


```{r}
df_cont_other <- data_demographics %>%
    select(millennium.id, year) %>%
    left_join(
        data_med_cont_10q2[c(id_col, "overlap")],
        by = id_col
    ) %>%
    left_join(
        data_meds_mag_dosing[c(id_col, "n")],
        by = id_col
    ) %>%
    mutate_at("overlap", as.numeric) %>%
    rename(mag.doses = n)

vars <- c(
    "overlap" = "Duration of combined continous albuterol 10 mg/hr and 10 puffs every 2 hr (hours)",
    "mag.doses" = "Number of magnesium doses"
)

cap <- "Other continuous data"

df_cont_other %>%
    make_cont_table(
        var_name = vars,
        caption = cap,
        overlap, mag.doses
    )

```


```{r}
df_allergy <- data_meds_allergy_first %>%
    full_join(
        data_demographics[c(id_col, "year")],
        by = id_col
    ) %>%
    mutate(allergy.med = !is.na(med))

p_allergy <- df_allergy %>%
    p_cat(allergy.med, med)
```

